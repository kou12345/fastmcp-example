MCP server に local のファイルを read, write する tool を作成する

Gemini API を使って、local のファイルを編集する

# ローカルファイルアクセスツールの設計

## 目的

LLM (大規模言語モデル) が、事前に指定された特定のローカルディレクトリ内に限り、ファイルの読み取りおよび書き込み操作を行えるようにするための MCP (Model Context Protocol) ツールを提供する。

## 背景

LLM がタスクを実行する上で、ローカルファイルシステム上の情報（設定ファイル、データファイル、スクリプトなど）を参照したり、生成した結果（コード、レポート、設定など）をローカルファイルとして保存したりする必要がある。しかし、無制限なファイルアクセスは重大なセキュリティリスクとなるため、アクセス可能な範囲を厳密に制限する必要がある。

## 機能要件

1.  **ファイル読み取り機能 (`read_local_file`)**
    - 引数として読み取りたいファイルのパス (`file_path: str`) を受け取る。
    - 指定されたパスが、事前に設定された「読み取り許可ディレクトリ」内にある場合に限り、ファイルの内容を読み取り、その内容 (`str`) を返す。
    - 許可されていないパスの場合や、ファイルが存在しない場合は、エラーを示す文字列を返す。
2.  **ファイル書き込み機能 (`write_local_file`)**
    - 引数として書き込みたいファイルのパス (`file_path: str`) と、書き込む内容 (`content: str`) を受け取る。
    - 指定されたパスが、事前に設定された「書き込み許可ディレクトリ」内にある場合に限り、指定された内容でファイルに書き込む（既存ファイルは上書きされる）。
    - 書き込み成功時には成功を示す文字列を、許可されていないパスの場合や書き込みに失敗した場合はエラーを示す文字列を返す。
    - (オプション) 書き込み先の親ディレクトリが存在しない場合は自動的に作成する。
3.  **ディレクトリ一覧表示機能 (`list_directory`)**
    - 引数として一覧表示したいディレクトリのパス (`dir_path: str`) を受け取る。
    - 指定されたパスが「読み取り許可ディレクトリ」内にあるディレクトリの場合に限り、そのディレクトリ直下のファイルとディレクトリの名前のリスト (`list[str]`) を返す。
    - 許可されていないパスの場合、パスがファイルの場合、またはディレクトリが存在しない場合は、エラーを示す文字列を返す。
4.  **ファイルパターン検索機能 (`find_files_by_pattern`)**
    - 引数として検索基点のディレクトリパス (`base_dir: str`) と、検索パターン (`pattern: str`, 例: `*.py`) を受け取る。
    - オプション引数として再帰検索フラグ (`recursive: bool = False`) を受け取る。
    - 指定された `base_dir` が「読み取り許可ディレクトリ」内にある場合に限り、`base_dir` 以下（`recursive=True` の場合はサブディレクトリも含む）で `pattern` に一致するファイル/ディレクトリのパスのリスト (`list[str]`) を返す。
    - 許可されていない `base_dir` の場合はエラーを示す文字列を返す。
5.  **ファイル内容検索機能 (`search_content_in_files`)**
    - 引数として検索対象のファイルパスまたはディレクトリパス (`search_path: str`) と、検索する正規表現パターン (`regex_pattern: str`) を受け取る。
    - オプション引数として再帰検索フラグ (`recursive: bool = False`, `search_path` がディレクトリの場合のみ有効) と、最大結果数 (`max_results: int = 50`) を受け取る。
    - 指定された `search_path` が「読み取り許可ディレクトリ」内にある場合に限り、対象ファイル（`recursive=True` の場合はサブディレクトリ内のファイルも含む）の内容を一行ずつ正規表現で検索する。
    - 一致した箇所が見つかった場合、`"ファイルパス:行番号:一致した行の内容"` 形式の文字列のリスト (`list[str]`) を `max_results` 件まで返す。
    - 許可されていないパスの場合、パターンが不正な場合、または読み取りエラーが発生した場合は、エラーを示す文字列を返す。

## 非機能要件 / 制約

1.  **セキュリティ:**
    - **ディレクトリ制限:** 読み取りおよび書き込みが許可されるディレクトリ（複数可）をサーバー起動時または設定ファイルで明確に指定する。これらのリスト外へのアクセスは絶対に許可しない。
    - **パス検証:** `file_path` 引数で与えられたパスが、許可されたディレクトリの配下にあることを厳密に検証する。`../` などを用いたディレクトリトラバーサル攻撃を確実に防止する。シンボリックリンクの解決も考慮する (`os.path.realpath`)。
2.  **エラーハンドリング:**
    - ファイルが存在しない (`FileNotFoundError`)。
    - アクセス権限がない (`PermissionError`)。
    - 指定されたパスが許可されたディレクトリ外である。
    - その他の予期せぬ I/O エラー。
      上記のような場合に、LLM が理解しやすい明確なエラーメッセージを返す。
3.  **使いやすさ (LLM にとって):**
    - ツールの関数名、引数名、説明文 (docstring) は、LLM がその機能を理解しやすいように記述する。
    - 成功・失敗のステータスが戻り値から明確に判断できるようにする。

## ツール定義 (FastMCP)

- `@mcp.tool()` デコレータを用いて、上記の `read_local_file` と `write_local_file` 関数をツールとして登録する。
- Python の型ヒントを用いて、引数と戻り値の型を明示する。
